<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>點讀小卡製作工具</title>
    
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 FontAwesome 圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 載入 React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 載入 Babel 以便在瀏覽器中編譯 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* 隱藏滾動條但保留滾動功能，讓畫面更乾淨 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // --- 預設資料模型 ---
        const DEFAULT_CELL = {
            image: null,
            scale: 1,
            x: 0,
            y: 0,
            rotate: 0,
            text: '',
            zhuyin: '',
            textFontSize: 24,
            textLetterSpacing: 0,
            textColor: '#1e293b',
            textX: 0,
            textY: 0,
            circleX: 0,
            circleY: 0
        };

        const DEFAULT_TITLE = {
            text: '自訂標題',
            bgColor: '#ffffff',
            bgImage: null,
            fontSize: 24,
            letterSpacing: 4,
            color: '#000000'
        };

        const TEMPLATES = [
            { id: 'T1', name: '模板一 (橫向四格)', width: 10.5, height: 7.5 },
            { id: 'T2', name: '模板二 (直向三格)', width: 7.5, height: 10.5 }
        ];

        function App() {
            // --- 狀態管理 ---
            const [step, setStep] = useState(1); // 1: 設定頁, 2: 編輯頁
            
            // 設定狀態
            const [config, setConfig] = useState({
                template: 'T1',
                border: 'square', // square, rounded, none
                zhuyin: false,
                outputSize: 'card', // card, a6, 3x5, 4x6
                exportFormat: 'pdf', // pdf, jpg
                bgImage: null
            });

            // 內容狀態
            const [titleData, setTitleData] = useState({ ...DEFAULT_TITLE });
            const [cells, setCells] = useState(Array(4).fill(null).map(() => ({ ...DEFAULT_CELL })));
            
            // UI 狀態
            const [activeElement, setActiveElement] = useState(null); // { type: 'title' } or { type: 'cell', index: 0 }
            const [isExporting, setIsExporting] = useState(false);
            const [zoom, setZoom] = useState(1);
            const workspaceRef = useRef(null);

            // --- 處理圖片上傳 ---
            const handleImageUpload = (e, callback) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    callback(url);
                }
            };

            // --- 匯出檔案 (PDF 或 JPG) ---
            const handleExport = async () => {
                setIsExporting(true);
                setActiveElement(null); // 隱藏選取框
                
                // 等待 React 重新渲染隱藏選取狀態
                await new Promise(r => setTimeout(r, 100));

                try {
                    // 1. 確保 html2canvas 載入
                    if (!window.html2canvas) {
                        await new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                            script.onload = resolve;
                            script.onerror = reject;
                            document.head.appendChild(script);
                        });
                    }

                    // 2. 將畫面轉為高畫質 Canvas
                    const element = document.getElementById('card-export-target');
                    const canvas = await window.html2canvas(element, {
                        scale: 4, // 提高匯出畫質
                        useCORS: true,
                        backgroundColor: null
                    });

                    if (config.exportFormat === 'jpg') {
                        // 匯出 JPG
                        const url = canvas.toDataURL('image/jpeg', 1.0);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `點讀小卡_${new Date().getTime()}.jpg`;
                        a.click();
                    } else if (config.exportFormat === 'pdf') {
                        // 匯出 PDF
                        if (!window.jspdf) {
                            await new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                                script.onload = resolve;
                                script.onerror = reject;
                                document.head.appendChild(script);
                            });
                        }

                        // 根據選擇尺寸決定 PDF 實體長寬 (單位: mm)
                        let pdfWidth = config.template === 'T1' ? 105 : 75;
                        let pdfHeight = config.template === 'T1' ? 75 : 105;
                        
                        if (config.outputSize === 'a6') {
                            pdfWidth = config.template === 'T1' ? 148 : 105;
                            pdfHeight = config.template === 'T1' ? 105 : 148;
                        } else if (config.outputSize === '3x5') {
                            pdfWidth = config.template === 'T1' ? 127 : 76.2;
                            pdfHeight = config.template === 'T1' ? 76.2 : 127;
                        } else if (config.outputSize === '4x6') {
                            pdfWidth = config.template === 'T1' ? 152.4 : 101.6;
                            pdfHeight = config.template === 'T1' ? 101.6 : 152.4;
                        }

                        const pdf = new window.jspdf.jsPDF({
                            orientation: config.template === 'T1' ? 'landscape' : 'portrait',
                            unit: 'mm',
                            format: [pdfWidth, pdfHeight]
                        });

                        const imgData = canvas.toDataURL('image/jpeg', 1.0);
                        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(`點讀小卡_${new Date().getTime()}.pdf`);
                    }

                } catch (error) {
                    console.error('匯出失敗:', error);
                    alert('檔案匯出失敗，請稍後再試。');
                } finally {
                    setIsExporting(false);
                }
            };

            // -------------------------------------------------------------
            // 第一步：規格設定頁面
            // -------------------------------------------------------------
            if (step === 1) {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6 font-sans text-slate-800">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-2xl">
                            <h1 className="text-3xl font-extrabold text-center mb-8 text-indigo-600 flex items-center justify-center gap-3">
                                <i className="fas fa-cog"></i>
                                點讀小卡製作工具
                            </h1>

                            <div className="space-y-6">
                                {/* 模板選擇 */}
                                <div>
                                    <label className="block text-sm font-semibold mb-2">1. 選擇模板</label>
                                    <div className="grid grid-cols-2 gap-4">
                                        {TEMPLATES.map(t => (
                                            <div 
                                                key={t.id}
                                                onClick={() => {
                                                    setConfig({...config, template: t.id});
                                                    setCells(Array(t.id === 'T1' ? 4 : 3).fill(null).map(() => ({ ...DEFAULT_CELL })));
                                                }}
                                                className={`border-2 rounded-xl p-4 cursor-pointer transition-all ${
                                                    config.template === t.id ? 'border-indigo-500 bg-indigo-50/50' : 'border-slate-200 hover:border-indigo-300'
                                                }`}
                                            >
                                                <div className="text-center font-medium text-slate-700">{t.name}</div>
                                                <div className="text-xs text-center text-slate-500 mt-1">
                                                    {t.id === 'T1' ? '右側標題 / 左側田字型' : '頂部標題 / 下方 3x1 直排'}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* 外框選擇 */}
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">2. 外框樣式</label>
                                        <select 
                                            className="w-full border-slate-300 rounded-lg p-3 bg-slate-50 focus:ring-indigo-500 focus:border-indigo-500 border"
                                            value={config.border}
                                            onChange={(e) => setConfig({...config, border: e.target.value})}
                                        >
                                            <option value="none">無框</option>
                                            <option value="square">方框</option>
                                            <option value="rounded">圓角框</option>
                                        </select>
                                    </div>

                                    {/* 輸出尺寸 */}
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">3. 圖檔輸出尺寸</label>
                                        <select 
                                            className="w-full border-slate-300 rounded-lg p-3 bg-slate-50 focus:ring-indigo-500 focus:border-indigo-500 border"
                                            value={config.outputSize}
                                            onChange={(e) => setConfig({...config, outputSize: e.target.value})}
                                        >
                                            <option value="card">標準點讀小卡 (7.5 x 10.5cm)</option>
                                            <option value="a6">A6 尺寸</option>
                                            <option value="3x5">3x5 吋照片</option>
                                            <option value="4x6">4x6 吋照片</option>
                                        </select>
                                    </div>
                                </div>

                                {/* 輸出檔案類型 */}
                                <div>
                                    <label className="block text-sm font-semibold mb-2">4. 輸出檔案類型</label>
                                    <div className="flex gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer bg-slate-100 px-4 py-2 rounded-lg border border-slate-200 hover:bg-slate-200 transition">
                                            <input type="radio" name="exportFormat" checked={config.exportFormat === 'pdf'} onChange={() => setConfig({...config, exportFormat: 'pdf'})} className="text-indigo-600 focus:ring-indigo-500 w-5 h-5"/>
                                            <span className="font-medium text-slate-700">PDF 文件</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer bg-slate-100 px-4 py-2 rounded-lg border border-slate-200 hover:bg-slate-200 transition">
                                            <input type="radio" name="exportFormat" checked={config.exportFormat === 'jpg'} onChange={() => setConfig({...config, exportFormat: 'jpg'})} className="text-indigo-600 focus:ring-indigo-500 w-5 h-5"/>
                                            <span className="font-medium text-slate-700">JPG 圖檔</span>
                                        </label>
                                    </div>
                                </div>

                                {/* 注音選項 */}
                                <div>
                                    <label className="block text-sm font-semibold mb-2">5. 文字注音功能</label>
                                    <div className="flex gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="zhuyin" checked={!config.zhuyin} onChange={() => setConfig({...config, zhuyin: false})} className="text-indigo-600 focus:ring-indigo-500 w-5 h-5"/>
                                            <span>無</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="zhuyin" checked={config.zhuyin} onChange={() => setConfig({...config, zhuyin: true})} className="text-indigo-600 focus:ring-indigo-500 w-5 h-5"/>
                                            <span>有 (自動縮小字型並預留注音空間)</span>
                                        </label>
                                    </div>
                                </div>

                                {/* 背景圖片上傳 */}
                                <div>
                                    <label className="block text-sm font-semibold mb-2">6. 全局背景底圖 (選填)</label>
                                    <div className="flex items-center gap-4">
                                        <label className="flex items-center justify-center px-4 py-2 bg-slate-100 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition text-sm">
                                            <i className="fas fa-upload mr-2"></i>
                                            上傳背景圖
                                            <input type="file" className="hidden" accept="image/*" onChange={(e) => handleImageUpload(e, (url) => setConfig({...config, bgImage: url}))} />
                                        </label>
                                        {config.bgImage && (
                                            <button onClick={() => setConfig({...config, bgImage: null})} className="text-red-500 text-sm hover:underline">
                                                移除背景
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <button 
                                onClick={() => setStep(2)}
                                className="w-full mt-8 bg-indigo-600 text-white font-bold text-lg py-4 rounded-xl hover:bg-indigo-700 transition flex items-center justify-center gap-2"
                            >
                                開始編輯
                                <i className="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                );
            }

            // -------------------------------------------------------------
            // 第二步：編輯頁面
            // -------------------------------------------------------------
            
            const isT1 = config.template === 'T1';
            const aspectStyle = isT1 ? { aspectRatio: '10.5 / 7.5' } : { aspectRatio: '7.5 / 10.5' };
            
            const getBorderClass = () => {
                if (config.border === 'square') return 'border-2 border-slate-800';
                if (config.border === 'rounded') return 'border-2 border-slate-800 rounded-xl overflow-hidden';
                return ''; // none
            };
            const getInnerBorderClass = () => {
                if (config.border === 'none') return '';
                return 'border border-slate-400';
            };

            return (
                <div className="h-screen flex flex-col bg-slate-800 text-slate-100 font-sans overflow-hidden">
                    {/* 頂部工具列 */}
                    <header className="h-16 bg-slate-900 flex items-center justify-between px-6 shadow-md z-20">
                        <button onClick={() => setStep(1)} className="flex items-center gap-2 text-slate-300 hover:text-white transition">
                            <i className="fas fa-arrow-left"></i> 重新設定
                        </button>
                        
                        <div className="flex items-center gap-4">
                            <div className="flex items-center bg-slate-800 rounded-lg p-1 mr-4">
                                <button onClick={() => setZoom(z => Math.max(0.5, z - 0.1))} className="p-2 hover:bg-slate-700 rounded text-slate-400"><i className="fas fa-search-minus"></i></button>
                                <span className="text-xs px-2 w-12 text-center">{Math.round(zoom * 100)}%</span>
                                <button onClick={() => setZoom(z => Math.min(2, z + 0.1))} className="p-2 hover:bg-slate-700 rounded text-slate-400"><i className="fas fa-search-plus"></i></button>
                            </div>
                            <button 
                                onClick={handleExport}
                                disabled={isExporting}
                                className="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2 rounded-lg font-semibold flex items-center gap-2 transition disabled:opacity-50"
                            >
                                <i className="fas fa-download"></i>
                                {isExporting ? '匯出中...' : `匯出 ${config.exportFormat.toUpperCase()}`}
