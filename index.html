<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>點讀小卡製作工具</title>
    
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 FontAwesome 圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 載入 React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 載入 Babel 以便在瀏覽器中編譯 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* 隱藏滾動條但保留滾動功能，讓畫面更乾淨 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* 避免手機上長按反白 */
        body { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        input[type="text"] { -webkit-user-select: auto; user-select: auto; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 共用：動態載入外部腳本 (加上防呆機制) ---
        const loadScript = (src) => new Promise((resolve, reject) => {
            if (document.querySelector(`script[src="${src}"]`)) return resolve();
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });

        // --- 文字描邊專用組件 (徹底修復白畫面 Bug) ---
        const StrokeText = ({ text, color, strokeColor, strokeWidth, strokeOpacity, fontSize, letterSpacing }) => {
            // 確保數值型別正確，防止 NaN 導致渲染崩潰
            const numStrokeWidth = Number(strokeWidth) || 0;
            const numFontSize = Number(fontSize) || 16;
            
            // 獨立計算 RGBA 顏色，供描邊與陰影共用
            const strokeColorRgba = useMemo(() => {
                let hex = strokeColor || '#ffffff';
                hex = hex.replace('#', '');
                if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
                const r = parseInt(hex.substring(0, 2), 16) || 255;
                const g = parseInt(hex.substring(2, 4), 16) || 255;
                const b = parseInt(hex.substring(4, 6), 16) || 255;
                const opacity = !isNaN(Number(strokeOpacity)) ? Number(strokeOpacity) / 100 : 1;
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }, [strokeColor, strokeOpacity]);

            // 利用 16 方向陰影疊加，完美模擬無死角的文字描邊 (解決 iOS/PDF 描邊消失 Bug)
            const textShadow = useMemo(() => {
                if (numStrokeWidth <= 0) return 'none';
                
                const steps = 16;
                let shadows = [];
                for (let i = 0; i < steps; i++) {
                    const angle = (i * 2 * Math.PI) / steps;
                    const x = (numStrokeWidth * Math.cos(angle)).toFixed(1);
                    const y = (numStrokeWidth * Math.sin(angle)).toFixed(1);
                    shadows.push(`${x}px ${y}px 0px ${strokeColorRgba}`);
                }
                // 較粗的描邊補上內圈，防止文字邊緣出現空隙
                if (numStrokeWidth > 2) {
                    const innerWidth = numStrokeWidth / 2;
                    for (let i = 0; i < steps; i++) {
                        const angle = (i * 2 * Math.PI) / steps;
                        const x = (innerWidth * Math.cos(angle)).toFixed(1);
                        const y = (innerWidth * Math.sin(angle)).toFixed(1);
                        shadows.push(`${x}px ${y}px 0px ${strokeColorRgba}`);
                    }
                }
                return shadows.join(', ');
            }, [numStrokeWidth, strokeColorRgba]);

            if (!text) return null;
            
            // 使用絕對的像素級行高防跑位
            const fixedLineHeight = `${numFontSize * 1.2}px`;

            return (
                <div style={{ position: 'relative', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                    {/* 底層：原生 CSS 描邊層 (提供額外覆蓋保護) */}
                    {numStrokeWidth > 0 && (
                        <div className="font-bold" style={{
                            position: 'absolute',
                            WebkitTextStroke: `${numStrokeWidth}px ${strokeColorRgba}`,
                            color: strokeColorRgba, 
                            zIndex: 1, whiteSpace: 'nowrap',
                            fontSize: `${numFontSize}px`, letterSpacing: `${letterSpacing}px`, lineHeight: fixedLineHeight
                        }}>
                            {text}
                        </div>
                    )}
                    {/* 頂層：文字填色與陰影疊加層 */}
                    <div className="font-bold" style={{
                        position: 'relative', color: color,
                        zIndex: 2, whiteSpace: 'nowrap',
                        fontSize: `${numFontSize}px`, letterSpacing: `${letterSpacing}px`, lineHeight: fixedLineHeight,
                        textShadow: textShadow // 加上 shadow 防止匯出時描邊消失
                    }}>
                        {text}
                    </div>
                </div>
            );
        };

        // --- 預設資料模型 ---
        const DEFAULT_CELL = {
            image: null, scale: 1, x: 0, y: 0, rotate: 0,
            text: '', zhuyin: '',
            textFontSize: 61, // 預設 61px，在 800px(10.5cm) 畫布下約等於 0.8cm 高
            textLetterSpacing: 0, textColor: '#1e293b',
            textStrokeColor: '#ffffff', textStrokeWidth: 4, textStrokeOpacity: 100,     
            textX: 0, textY: 0, circleX: 0, circleY: 0
        };

        const DEFAULT_TITLE = {
            text: '自訂標題', bgColor: '#ffffff', bgImage: null,
            fontSize: 24, letterSpacing: 4, color: '#000000'
        };

        const TEMPLATES = [
            { id: 'T1', name: '模板一 (橫向四格)', width: 10.5, height: 7.5 },
            { id: 'T2', name: '模板二 (直向三格)', width: 7.5, height: 10.5 }
        ];

        function App() {
            const [step, setStep] = useState(1); 
            const [config, setConfig] = useState({
                template: 'T1', border: 'square', zhuyin: false,
                outputSize: 'card', exportFormat: 'pdf', bgImage: null
            });
            const [titleData, setTitleData] = useState({ ...DEFAULT_TITLE });
            const [cells, setCells] = useState(Array(4).fill(null).map(() => ({ ...DEFAULT_CELL })));
            
            const isMobile = typeof window !== 'undefined' && window.innerWidth < 768;
            const getInitialZoom = () => isMobile ? 0.45 : 1;
            const [activeElement, setActiveElement] = useState(null);
            const [isExporting, setIsExporting] = useState(false);
            const [zoom, setZoom] = useState(getInitialZoom());

            useEffect(() => { if (step === 1) setZoom(getInitialZoom()); }, [step]);

            const updateCell = (index, key, value) => {
                setCells(prev => {
                    const newCells = [...prev];
                    newCells[index] = { ...newCells[index], [key]: value };
                    return newCells;
                });
            };

            const updateTitle = (key, value) => {
                setTitleData(prev => ({ ...prev, [key]: value }));
            };

            const handleImageUpload = (e, callback, oldUrl = null) => {
                const file = e.target.files[0];
                if (file) {
                    if (oldUrl) URL.revokeObjectURL(oldUrl); 
                    callback(URL.createObjectURL(file));
                }
                e.target.value = ''; 
            };

            const downloadBlob = (base64Url, filename) => {
                const arr = base64Url.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                const blob = new Blob([u8arr], { type: mime });
                const blobUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(blobUrl);
                }, 100);
            };

            // --- 匯出檔案 ---
            const handleExport = async () => {
                setIsExporting(true);
                setActiveElement(null); 
                
                const currentZoom = zoom;
                setZoom(1);
                await new Promise(r => setTimeout(r, 300)); 

                try {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js');
                    
                    const element = document.getElementById('card-export-target');
                    const isT1 = config.template === 'T1';
                    const baseCanvasWidth = isT1 ? 800 : 600;
                    const baseCanvasHeight = isT1 ? 800 * (7.5 / 10.5) : 600 * (10.5 / 7.5);
                    
                    const exportRatio = isMobile ? 2 : 4;

                    const dataUrl = await window.htmlToImage.toJpeg(element, { 
                        pixelRatio: exportRatio, 
                        backgroundColor: '#ffffff',
                        width: baseCanvasWidth,
                        height: baseCanvasHeight,
                        style: { transform: 'none', transformOrigin: 'top left', margin: '0' }
                    });

                    if (config.exportFormat === 'jpg') {
                        downloadBlob(dataUrl, `點讀小卡_${new Date().getTime()}.jpg`);
                    } else if (config.exportFormat === 'pdf') {
                        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');

                        let pdfWidth = isT1 ? 105 : 75;
                        let pdfHeight = isT1 ? 75 : 105;
                        
                        if (config.outputSize === 'a6') {
                            pdfWidth = isT1 ? 148 : 105;
                            pdfHeight = isT1 ? 105 : 148;
                        } else if (config.outputSize === '3x5') {
                            pdfWidth = isT1 ? 127 : 76.2;
                            pdfHeight = isT1 ? 76.2 : 127;
                        } else if (config.outputSize === '4x6') {
                            pdfWidth = isT1 ? 152.4 : 101.6;
                            pdfHeight = isT1 ? 101.6 : 152.4;
                        }

                        const pdf = new window.jspdf.jsPDF({
                            orientation: isT1 ? 'landscape' : 'portrait',
                            unit: 'mm',
                            format: [pdfWidth, pdfHeight]
                        });

                        const canvasRatio = baseCanvasWidth / baseCanvasHeight;
                        const paperRatio = pdfWidth / pdfHeight;
                        let printW = pdfWidth;
                        let printH = pdfHeight;

                        if (canvasRatio > paperRatio) {
                            printW = pdfWidth;
                            printH = pdfWidth / canvasRatio;
                        } else {
                            printH = pdfHeight;
                            printW = pdfHeight * canvasRatio;
                        }
                        
                        const x = (pdfWidth - printW) / 2;
                        const y = (pdfHeight - printH) / 2;

                        pdf.addImage(dataUrl, 'JPEG', x, y, printW, printH);
                        pdf.save(`點讀小卡_${new Date().getTime()}.pdf`);
                    }
                } catch (error) {
                    console.error('匯出失敗:', error);
                    alert('檔案匯出失敗，請稍後再試。');
                } finally {
                    setZoom(currentZoom);
                    setIsExporting(false);
                }
            };

            // -------------------------------------------------------------
            // 第一步：規格設定頁面
            // -------------------------------------------------------------
            if (step === 1) {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 md:p-6 font-sans text-slate-800">
                        <div className="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-2xl">
                            <h1 className="text-2xl md:text-3xl font-extrabold text-center mb-8 text-indigo-600 flex items-center justify-center gap-3">
                                <i className="fas fa-cog"></i>點讀小卡製作工具
                            </h1>
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-semibold mb-2">1. 選擇模板</label>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {TEMPLATES.map(t => (
                                            <div 
                                                key={t.id}
                                                onClick={() => {
                                                    setConfig({...config, template: t.id});
                                                    setCells(Array(t.id === 'T1' ? 4 : 3).fill(null).map(() => ({ ...DEFAULT_CELL })));
                                                    setActiveElement(null); 
                                                }}
                                                className={`border-2 rounded-xl p-4 cursor-pointer transition-all ${config.template === t.id ? 'border-indigo-500 bg-indigo-50/50' : 'border-slate-200 hover:border-indigo-300'}`}
                                            >
                                                <div className="text-center font-medium text-slate-700">{t.name}</div>
                                                <div className="text-xs text-center text-slate-500 mt-1">
                                                    {t.id === 'T1' ? '右側標題 / 左側田字型' : '頂部標題 / 下方 3x1 直排'}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">2. 外框樣式</label>
                                        <select 
                                            className="w-full border-slate-300 rounded-lg p-3 bg-slate-50 focus:ring-indigo-500 focus:border-indigo-500 border"
                                            value={config.border} onChange={(e) => setConfig({...config, border: e.target.value})}
                                        >
                                            <option value="none">無框</option><option value="square">方框</option><option value="rounded">圓角框</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">3. 圖檔輸出尺寸</label>
                                        <select 
                                            className="w-full border-slate-300 rounded-lg p-3 bg-slate-50 focus:ring-indigo-500 focus:border-indigo-500 border"
                                            value={config.outputSize} onChange={(e) => setConfig({...config, outputSize: e.target.value})}
                                        >
                                            <option value="card">標準點讀小卡 (7.5 x 10.5cm)</option><option value="a6">A6 尺寸</option>
                                            <option value="3x5">3x5 吋照片</option><option value="4x6">4x6 吋照片</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold mb-2">4. 輸出檔案類型</label>
                                    <div className="flex flex-wrap gap-4">
                                        {['pdf', 'jpg'].map(type => (
                                            <label key={type} className="flex items-center gap-2 cursor-pointer bg-slate-100 px-4 py-2 rounded-lg border border-slate-200 hover:bg-slate-200 transition">
                                                <input type="radio" name="exportFormat" checked={config.exportFormat === type} onChange={() => setConfig({...config, exportFormat: type})} className="text-indigo-600 focus:ring-indigo-500 w-5 h-5"/>
                                                <span className="font-medium text-slate-700">{type.toUpperCase()} {type === 'pdf' ? '文件' : '圖檔'}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold mb-2">5. 文字注音功能</label>
                                    <div className="flex flex-wrap gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="zhuyin" checked={!config.zhuyin} onChange={() => setConfig({...config, zhuyin: false})} className="text-indigo-600 focus:ring-indigo-500 w-5 h-5"/>
                                            <span>無</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="zhuyin" checked={config.zhuyin} onChange={() => setConfig({...config, zhuyin: true})} className="text-indigo-600 focus:ring-indigo-500 w-5 h-5"/>
                                            <span>有 (預留注音空間)</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold mb-2">6. 全局背景底圖 (選填)</label>
                                    <div className="flex flex-wrap items-center gap-4">
                                        <label className="flex items-center justify-center px-4 py-2 bg-slate-100 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition text-sm">
                                            <i className="fas fa-upload mr-2"></i>上傳背景圖
                                            <input type="file" className="hidden" accept="image/*" onChange={(e) => handleImageUpload(e, (url) => setConfig({...config, bgImage: url}), config.bgImage)} />
                                        </label>
                                        {config.bgImage && <button onClick={() => {
                                            URL.revokeObjectURL(config.bgImage);
                                            setConfig({...config, bgImage: null});
                                        }} className="text-red-500 text-sm hover:underline">移除背景</button>}
                                    </div>
                                </div>
                            </div>
                            <button onClick={() => setStep(2)} className="w-full mt-8 bg-indigo-600 text-white font-bold text-lg py-4 rounded-xl hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                                開始編輯 <i className="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                );
            }

            // -------------------------------------------------------------
            // 第二步：編輯頁面
            // -------------------------------------------------------------
            const isT1 = config.template === 'T1';
            const baseCanvasWidth = isT1 ? 800 : 600;
            const baseCanvasHeight = isT1 ? 800 * (7.5 / 10.5) : 600 * (10.5 / 7.5);
            
            const borderClass = config.border === 'square' ? 'border-2 border-slate-800' : 
                                config.border === 'rounded' ? 'border-2 border-slate-800 rounded-xl overflow-hidden' : '';
            const innerBorderClass = config.border !== 'none' ? 'border border-slate-400' : '';

            const isCellActive = activeElement?.type === 'cell';
            const activeCellIndex = isCellActive ? activeElement.index : -1;
            const activeCellData = isCellActive ? cells[activeCellIndex] : null;

            const CellsBlock = (
                <div className={`w-full h-full grid ${isT1 ? 'grid-cols-2 grid-rows-2' : 'grid-cols-1 grid-rows-3'}`} style={{ [isT1 ? 'width' : 'height']: '90.476%' }}>
                    {cells.map((cell, idx) => (
                        <CellRenderer 
                            key={idx} cell={cell} idx={idx} 
                            isActive={activeElement?.type === 'cell' && activeElement?.index === idx}
                            onClick={() => setActiveElement({ type: 'cell', index: idx })}
                            config={config} innerBorder={innerBorderClass}
                            circleSize={isT1 ? "25.26%" : "16%"}
                            isT1={isT1} 
                        />
                    ))}
                </div>
            );

            const TitleBlock = (
                <div 
                    className={`relative cursor-pointer overflow-hidden flex items-center justify-center ${innerBorderClass} ${activeElement?.type === 'title' && !isExporting ? 'ring-4 ring-indigo-500 ring-inset z-10' : ''}`}
                    style={{ [isT1 ? 'width' : 'height']: '9.524%', [isT1 ? 'height' : 'width']: '100%', backgroundColor: titleData.bgImage ? 'transparent' : titleData.bgColor }}
                    onClick={() => setActiveElement({ type: 'title' })}
                >
                    {titleData.bgImage && <img src={titleData.bgImage} className="absolute inset-0 w-full h-full object-cover" alt="Title BG" />}
                    
                    <div className="absolute inset-0 w-full h-full p-2 flex items-center justify-center">
                        <div className="font-bold whitespace-pre-wrap text-center" style={{ 
                            writingMode: isT1 ? 'vertical-rl' : 'horizontal-tb',
                            textOrientation: isT1 ? 'upright' : 'mixed', 
                            letterSpacing: `${titleData.letterSpacing}px`, 
                            fontSize: `${titleData.fontSize}px`, 
                            color: titleData.color, 
                            lineHeight: `${titleData.fontSize * 1.2}px` 
                        }}>
                            {titleData.text || '標題區域'}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="h-screen flex flex-col bg-slate-800 text-slate-100 font-sans overflow-hidden">
                    <header className="h-16 shrink-0 bg-slate-900 flex items-center justify-between px-3 md:px-6 shadow-md z-20">
                        <button onClick={() => { setStep(1); setActiveElement(null); }} className="flex items-center gap-2 text-slate-300 hover:text-white transition text-sm md:text-base">
                            <i className="fas fa-arrow-left"></i> <span className="hidden sm:inline">重新設定</span>
                        </button>
                        <div className="flex items-center gap-2 md:gap-4">
                            <div className="flex items-center bg-slate-800 rounded-lg p-1 mr-2 md:mr-4">
                                <button onClick={() => setZoom(z => Math.max(0.2, z - 0.1))} className="p-2 hover:bg-slate-700 rounded text-slate-400"><i className="fas fa-search-minus"></i></button>
                                <span className="text-xs px-2 w-10 md:w-12 text-center">{Math.round(zoom * 100)}%</span>
                                <button onClick={() => setZoom(z => Math.min(2, z + 0.1))} className="p-2 hover:bg-slate-700 rounded text-slate-400"><i className="fas fa-search-plus"></i></button>
                            </div>
                            <button onClick={handleExport} disabled={isExporting} className="bg-emerald-600 hover:bg-emerald-500 text-white px-3 md:px-5 py-2 rounded-lg text-sm md:text-base font-semibold flex items-center gap-2 transition disabled:opacity-50">
                                {isExporting ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-download"></i>}
                                {isExporting ? ' 匯出中...' : <span className="hidden sm:inline"> 匯出 {config.exportFormat.toUpperCase()}</span>}
                            </button>
                        </div>
                    </header>

                    <div className="flex-1 flex flex-col md:flex-row overflow-hidden min-h-0">
                        <div className="flex-1 bg-slate-950 overflow-auto p-4 md:p-8 relative" onClick={() => setActiveElement(null)}>
                            <div style={{ width: `${baseCanvasWidth * zoom}px`, height: `${baseCanvasHeight * zoom}px`, margin: '0 auto', position: 'relative' }}>
                                <div style={{ 
                                    width: `${baseCanvasWidth}px`, height: `${baseCanvasHeight}px`, 
                                    transform: zoom === 1 ? 'none' : `scale(${zoom})`, 
                                    transformOrigin: 'top left', transition: 'transform 0.2s ease-out', 
                                    position: 'absolute', top: 0, left: 0 
                                }}>
                                    <div id="card-export-target" className={`bg-white shadow-2xl ${borderClass}`} style={{ width: '100%', height: '100%', backgroundImage: config.bgImage ? `url(${config.bgImage})` : 'none', backgroundSize: 'cover', backgroundPosition: 'center', position: 'relative' }} onClick={(e) => e.stopPropagation()}>
                                        <div className={`absolute inset-0 flex ${isT1 ? '' : 'flex-col'}`}>
                                            {isT1 ? <>{CellsBlock}{TitleBlock}</> : <>{TitleBlock}{CellsBlock}</>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 控制面板 */}
                        <div className="h-[45%] md:h-full w-full md:w-80 shrink-0 bg-slate-900 border-t md:border-t-0 md:border-l border-slate-700 flex flex-col shadow-xl z-10 overflow-hidden">
                            <div className="p-3 md:p-4 border-b border-slate-800 bg-slate-800/50 shrink-0">
                                <h2 className="font-bold flex items-center gap-2 text-indigo-400 text-sm md:text-base"><i className="fas fa-sliders-h"></i> {activeElement ? '屬性編輯' : '操作提示'}</h2>
                            </div>
                            <div className="p-4 md:p-6 overflow-y-auto flex-1 pb-10">
                                {!activeElement && (
                                    <div className="text-slate-400 text-center flex flex-col items-center justify-center py-8 md:py-12 gap-4">
                                        <i className="fas fa-hand-pointer text-4xl md:text-5xl text-slate-600"></i>
                                        <p className="text-sm md:text-base">請點擊畫布中的<br/><span className="text-indigo-400">圖片區塊</span> 或 <span className="text-indigo-400">標題區域</span><br/>來開始編輯內容</p>
                                    </div>
                                )}

                                {activeElement?.type === 'title' && (
                                    <div className="space-y-4 md:space-y-6">
                                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                            <label className="block text-sm font-semibold mb-3 text-emerald-300 flex items-center gap-2"><i className="fas fa-font"></i> 標題文字設定</label>
                                            <input type="text" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white focus:border-indigo-500 focus:outline-none mb-4" value={titleData.text} onChange={(e) => updateTitle('text', e.target.value)} placeholder="輸入標題..." />
                                            <div className="space-y-4">
                                                <SliderControl icon={<i className="fas fa-text-height"></i>} label="字體大小" min="10" max="150" step="1" value={titleData.fontSize} onChange={(v) => updateTitle('fontSize', v)} />
                                                <SliderControl icon={<i className="fas fa-arrows-alt-h"></i>} label="字元間距" min="-5" max="50" step="1" value={titleData.letterSpacing} onChange={(v) => updateTitle('letterSpacing', v)} />
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="block text-xs text-slate-400 mb-1">文字顏色</label><input type="color" className="w-full h-8 rounded cursor-pointer border-none p-0 bg-transparent" value={titleData.color} onChange={(e) => updateTitle('color', e.target.value)} /></div>
                                                    <div><label className="block text-xs text-slate-400 mb-1">背景底色</label><input type="color" className="w-full h-8 rounded cursor-pointer border-none p-0 bg-transparent" value={titleData.bgColor} onChange={(e) => updateTitle('bgColor', e.target.value)} /></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                            <label className="block text-sm font-semibold mb-2 text-slate-300">上傳標題底圖</label>
                                            <label className="flex items-center justify-center px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg cursor-pointer hover:bg-slate-600 transition">
                                                <i className="fas fa-upload mr-2"></i> 上傳圖片
                                                <input type="file" className="hidden" accept="image/*" onChange={(e) => handleImageUpload(e, (url) => updateTitle('bgImage', url), titleData.bgImage)} />
                                            </label>
                                            {titleData.bgImage && <button onClick={() => {
                                                URL.revokeObjectURL(titleData.bgImage);
                                                updateTitle('bgImage', null);
                                            }} className="mt-2 text-red-400 text-sm hover:text-red-300 w-full text-center">移除圖片</button>}
                                        </div>
                                    </div>
                                )}

                                {isCellActive && (
                                    <div className="space-y-4 md:space-y-6">
                                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                            <label className="block text-sm font-semibold mb-3 text-indigo-300 flex items-center gap-2"><i className="fas fa-image"></i> 圖片設定</label>
                                            <label className="flex w-full items-center justify-center px-4 py-3 bg-indigo-600 text-white rounded-lg cursor-pointer hover:bg-indigo-500 transition mb-4 shadow-lg shadow-indigo-900/50">
                                                <i className="fas fa-upload mr-2"></i> 更換圖片
                                                <input type="file" className="hidden" accept="image/*" onChange={(e) => handleImageUpload(e, (url) => {
                                                    setCells(prev => {
                                                        const n = [...prev];
                                                        n[activeCellIndex] = { ...n[activeCellIndex], image: url, scale: 1, x: 0, y: 0, rotate: 0 };
                                                        return n;
                                                    });
                                                }, activeCellData.image)} />
                                            </label>
                                            <div className="space-y-4">
                                                <SliderControl icon={<i className="fas fa-search-plus"></i>} label="縮放" min="0.1" max="5" step="0.1" value={activeCellData.scale} onChange={(v) => updateCell(activeCellIndex, 'scale', v)} />
                                                <SliderControl icon={<i className="fas fa-arrows-alt-h"></i>} label="水平平移 (X)" min="-400" max="400" step="5" value={activeCellData.x} onChange={(v) => updateCell(activeCellIndex, 'x', v)} />
                                                <SliderControl icon={<i className="fas fa-arrows-alt-v"></i>} label="垂直平移 (Y)" min="-400" max="400" step="5" value={activeCellData.y} onChange={(v) => updateCell(activeCellIndex, 'y', v)} />
                                                <SliderControl icon={<i className="fas fa-redo"></i>} label="旋轉角度" min="-180" max="180" step="1" value={activeCellData.rotate} onChange={(v) => updateCell(activeCellIndex, 'rotate', v)} />
                                            </div>
                                        </div>

                                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                            <label className="block text-sm font-semibold mb-3 text-emerald-300 flex items-center gap-2"><i className="fas fa-font"></i> 單元文字與描邊設定</label>
                                            <input type="text" className="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white focus:border-emerald-500 focus:outline-none mb-2" value={activeCellData.text} onChange={(e) => updateCell(activeCellIndex, 'text', e.target.value)} placeholder="輸入文字 (無字數上限)" />
                                            {config.zhuyin && <input type="text" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white focus:border-emerald-500 focus:outline-none text-sm" value={activeCellData.zhuyin} onChange={(e) => updateCell(activeCellIndex, 'zhuyin', e.target.value)} placeholder="例：ㄉㄧㄢˇ ㄉㄨˊ" />}
                                            <div className="space-y-4 pt-4 border-t border-slate-700 mt-4">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="block text-xs text-slate-400 mb-1">文字顏色</label><input type="color" className="w-full h-8 rounded cursor-pointer border-none p-0 bg-transparent" value={activeCellData.textColor} onChange={(e) => updateCell(activeCellIndex, 'textColor', e.target.value)} /></div>
                                                    <div><label className="block text-xs text-slate-400 mb-1">描邊顏色</label><input type="color" className="w-full h-8 rounded cursor-pointer border-none p-0 bg-transparent" value={activeCellData.textStrokeColor} onChange={(e) => updateCell(activeCellIndex, 'textStrokeColor', e.target.value)} /></div>
                                                </div>
                                                <SliderControl icon={<i className="fas fa-border-all"></i>} label="描邊粗細" min="0" max="20" step="1" value={activeCellData.textStrokeWidth} onChange={(v) => updateCell(activeCellIndex, 'textStrokeWidth', v)} />
                                                <SliderControl icon={<i className="fas fa-eye"></i>} label="描邊不透明度 (%)" min="0" max="100" step="1" value={activeCellData.textStrokeOpacity} onChange={(v) => updateCell(activeCellIndex, 'textStrokeOpacity', v)} />
                                                <SliderControl icon={<i className="fas fa-text-height"></i>} label="字體大小 (預設約0.8cm高)" min="10" max="200" step="1" value={activeCellData.textFontSize} onChange={(v) => updateCell(activeCellIndex, 'textFontSize', v)} />
                                                <SliderControl icon={<i className="fas fa-expand-arrows-alt"></i>} label="字元間距" min="-5" max="50" step="1" value={activeCellData.textLetterSpacing} onChange={(v) => updateCell(activeCellIndex, 'textLetterSpacing', v)} />
                                                <div className="pt-2">
                                                    <div className="text-xs text-indigo-400 font-medium mb-2 border-b border-indigo-900 pb-1"><i className="fas fa-arrows-alt mr-1"></i> 文字位置微調</div>
                                                    <div className="space-y-4">
                                                        <SliderControl icon={<i className="fas fa-arrows-alt-h"></i>} label="水平移動 (X, 正數向右)" min="-800" max="800" step="5" value={activeCellData.textX} onChange={(v) => updateCell(activeCellIndex, 'textX', v)} />
                                                        <SliderControl icon={<i className="fas fa-arrows-alt-v"></i>} label="垂直移動 (Y, 負數向上)" min="-800" max="800" step="5" value={activeCellData.textY} onChange={(v) => updateCell(activeCellIndex, 'textY', v)} />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                            <label className="block text-sm font-semibold mb-3 text-amber-300 flex items-center gap-2"><i className="fas fa-circle-notch"></i> 點讀圓框定位 (預設右上角2mm安全線)</label>
                                            <div className="space-y-4">
                                                <SliderControl icon={<i className="fas fa-arrows-alt-h"></i>} label="圓框水平移動 (X, 正數向右)" min="-800" max="800" step="5" value={activeCellData.circleX} onChange={(v) => updateCell(activeCellIndex, 'circleX', v)} />
                                                <SliderControl icon={<i className="fas fa-arrows-alt-v"></i>} label="圓框垂直移動 (Y, 正數向下)" min="-800" max="800" step="5" value={activeCellData.circleY} onChange={(v) => updateCell(activeCellIndex, 'circleY', v)} />
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- 核心：單元格渲染與「智慧字串寬度估算防爆框」技術 (修復迴圈崩潰防呆版) ---
        function CellRenderer({ cell, idx, isActive, onClick, config, innerBorder, circleSize, isT1 }) {
            // 防呆處理，確保取得的數值皆為有效數字
            const finalFontSize = Number(cell.textFontSize) || 61;
            const letterSpacing = Number(cell.textLetterSpacing) || 0;
            const strokeWidth = Number(cell.textStrokeWidth) || 0;
            
            // 1. 計算當前模板下，單元格的最大安全寬度 (保留左右各約 20px 的安全距離)
            const MAX_WIDTH = isT1 ? 340 : 520;
            
            // 2. 智慧估算當前輸入字串的實際渲染寬度 (徹底修復 Babel 迴圈崩潰問題)
            let estWidth = 0;
            const textStr = String(cell.text || '');
            
            // 使用傳統 for 迴圈，避免舊版 Babel 缺乏 Symbol.iterator 導致 React 崩潰
            for (let i = 0; i < textStr.length; i++) {
                const charCode = textStr.charCodeAt(i);
                // 若為英數字元(ASCII)，寬度約為全寬的 0.6 倍，中文字則算全寬
                if (charCode >= 0 && charCode <= 255) {
                    estWidth += finalFontSize * 0.6;
                } else {
                    estWidth += finalFontSize;
                }
            }
            
            // 加上字距的總寬度
            if (textStr.length > 1) {
                estWidth += (textStr.length - 1) * letterSpacing;
            }
            // 加上描邊的粗細 (左右兩側)，避免描邊被切掉
            estWidth += strokeWidth * 2;

            // 3. 計算自動防爆框的縮放比例 (Scale)
            let autoScale = 1;
            if (estWidth > MAX_WIDTH && estWidth > 0) {
                autoScale = MAX_WIDTH / estWidth;
            }

            return (
                <div className={`relative overflow-hidden cursor-pointer group bg-white/50 ${innerBorder} ${isActive ? 'ring-4 ring-indigo-500 ring-inset z-10' : ''}`} onClick={onClick}>
                    {/* 圖片層 */}
                    {cell.image ? (
                        <div className="absolute inset-0 w-full h-full flex items-center justify-center">
                            <img src={cell.image} alt={`Cell ${idx}`} className="origin-center" style={{ maxWidth: '100%', maxHeight: '100%', width: 'auto', height: 'auto', display: 'block', transform: `translate(${cell.x}%, ${cell.y}%) scale(${cell.scale}) rotate(${cell.rotate}deg)` }} />
                        </div>
                    ) : (
                        <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-slate-100 group-hover:bg-slate-200 transition">
                            <i className="fas fa-image text-3xl opacity-50 mb-2"></i><span className="text-sm font-medium mt-2">點擊設定圖片</span>
                        </div>
                    )}

                    {/* 文字層 */}
                    {(cell.text || cell.zhuyin) && (
                        <div className="absolute pointer-events-none flex justify-center items-end" style={{ bottom: '8px', left: 0, right: 0 }}>
                            <div className="flex items-center justify-center" style={{ position: 'relative', left: `${cell.textX}px`, top: `${cell.textY}px` }}>
                                {/* 將自動計算出的 autoScale 套用在外層，確保整體等比縮放 */}
                                <div style={{ transform: `scale(${autoScale})`, transformOrigin: 'center bottom', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                                    {config.zhuyin && cell.zhuyin ? (
                                        <>
                                            <div style={{ marginBottom: '2px' }}>
                                                <StrokeText text={cell.zhuyin} color={cell.textColor} strokeColor={cell.textStrokeColor} strokeWidth={strokeWidth * 0.6} strokeOpacity={cell.textStrokeOpacity} fontSize={finalFontSize * 0.45} letterSpacing={0} />
                                            </div>
                                            <div>
                                                <StrokeText text={cell.text} color={cell.textColor} strokeColor={cell.textStrokeColor} strokeWidth={strokeWidth} strokeOpacity={cell.textStrokeOpacity} fontSize={finalFontSize} letterSpacing={letterSpacing} />
                                            </div>
                                        </>
                                    ) : (
                                        <div>
                                            <StrokeText text={cell.text} color={cell.textColor} strokeColor={cell.textStrokeColor} strokeWidth={strokeWidth} strokeOpacity={cell.textStrokeOpacity} fontSize={finalFontSize} letterSpacing={letterSpacing} />
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 點讀筆圓圈定位區 */}
                    <div className="absolute rounded-full border border-slate-400 bg-white/40 shadow-sm backdrop-blur-sm pointer-events-none" style={{ width: circleSize, borderWidth: 'max(1px, 0.3mm)', top: `${15 + cell.circleY}px`, right: `${15 - cell.circleX}px` }}>
                        <div style={{ paddingBottom: '100%' }}></div>
                    </div>
                </div>
            );
        }

        function SliderControl({ icon, label, min, max, step, value, onChange }) {
            return (
                <div>
                    <div className="flex justify-between text-xs text-slate-400 mb-1"><span className="flex items-center gap-1">{icon} {label}</span><span className="font-mono">{value}</span></div>
                    <input type="range" min={min} max={max} step={step} value={value} onChange={(e) => onChange(parseFloat(e.target.value))} className="w-full accent-indigo-500 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
